---
id: SCR-101
feature: organization-setup
name: Organization List & Create/Edit Organization
extends: templates/base.html
includes:
  - templates/partials/sidebar.html
  - templates/partials/topbar.html
roles: [SuperAdmin]   # Visible only to SuperAdmin in MULTI_TENANT; hidden in SINGLE_TENANT deploys
tenancy_mode: supports SINGLE_TENANT | MULTI_TENANT (config flag)
entities: [Organization]
workflows: [WF-101]   # Create/Update Organization (maker-checker)
business_rules: [BR-101, BR-102, BR-103]
validations: [VAL-101, VAL-102, VAL-103]
apis:
  - API-ORG-LIST:   GET /api/v1/organizations
  - API-ORG-GET:    GET /api/v1/organizations/{id}
  - API-ORG-CREATE: POST /api/v1/organizations
  - API-ORG-PATCH:  PATCH /api/v1/organizations/{id}
  - API-ORG-APPROVE: POST /api/v1/organizations/{id}:approve
  - API-ORG-REJECT:  POST /api/v1/organizations/{id}:reject
  - API-ORG-ACTIVATE:   POST /api/v1/organizations/{id}:activate
  - API-ORG-DEACTIVATE: POST /api/v1/organizations/{id}:deactivate
states: [Loading, Empty, Error, Draft, PendingApproval, Active, Inactive, Rejected]
status: Draft
data_exchange_format: JSON
---

# Purpose
Create and manage **Organizations (tenants)**. Super Admin can list, search, create, edit, activate/deactivate, and approve/reject changes via maker‑checker.

> **Tenancy**
> - **MULTI_TENANT**: Screen visible; Super Admin manages multiple Organizations.
> - **SINGLE_TENANT**: Screen **hidden**; a single Organization is seeded at deploy. API may remain for internal ops.

---

## Domain Model (Organization)
**Fields (server-side, schema-first; must exist in OpenAPI):**
- `id` (UUID, read-only)
- `code` (string ≤ 20, **unique**, uppercase A–Z0–9 + `_`; **immutable** once Active)
- `name` (string ≤ 120, **unique** platform-wide; case-insensitive compare)
- `login_domains` (array of strings, 1–5 items; validated FQDNs; used for SSO/user provisioning and optional routing)
- `vanity_domain` (string, optional; FQDN for custom domain or `<tenant>.<host>`, reserved but not required)
- `default_timezone` (IANA TZ database name, e.g., `Asia/Kolkata`)
- `default_country` (ISO‑3166‑1 alpha‑2)
- `default_currency` (ISO‑4217)
- `working_days` (array of ENUM: MON..SUN; default Mon–Fri)
- `leave_year_start` (date, MM‑DD semantics; e.g., `04-01` for Apr 1)
- `logo_file_id` (UUID, optional; references secure file store; upload handled by file API)
- `status` (ENUM: Draft | PendingApproval | Active | Inactive | Rejected)
- `created_at`, `updated_at`, `created_by`, `updated_by`

**Immutable after Active:** `code`  
**Soft delete policy:** use `Inactive`; no hard delete.

---

## List View (Index)
**Layout**
- Page title: “Organizations”
- Primary actions (top-right): `Create Organization`
- Table: `.table.table-striped.table-hover`

**Columns**
- Code, Name, Login Domains (comma-separated), Timezone, Status (badge), Created, Updated, Actions (View/Edit)

**Search & Filters**
- Search: by **name / code / domain**
- Filters:
  - Status: [All, Draft, Pending Approval, Active, Inactive, Rejected]
  - Created date range (optional)

**Bulk Actions**
- Select rows → `Activate`, `Deactivate`, `Export CSV`

**Empty State**
- Card with message “No organizations yet” + `Create Organization` button.

---

## Create / Edit Drawer (Modal or Page)
**Form Sections (accordion)**
1. **Identity**
   - Code (text, uppercase transform; helper: immutable after approval)
   - Name (text)
2. **Domains**
   - Login Domains (repeatable input chips, max 5)
   - Vanity Domain (optional)
3. **Defaults**
   - Timezone (select; default Asia/Kolkata)
   - Country (select)
   - Currency (select)
   - Working Days (7‑day checkboxes; default Mon–Fri)
   - Leave Year Start (month + day pickers)
4. **Branding**
   - Logo upload (PNG/JPG/SVG; ≤ 1MB)

**Actions**
- `Save as Draft` (stays Draft)
- `Submit for Approval` (transitions to PendingApproval; creates change set if editing)
- `Cancel`

**Edit behavior with maker‑checker**
- Editing an Active record creates a **pending change set**; Active version stays live until approval.
- Change set is visible in **Approvals** screens (SCR‑108/109).

---

## State & Maker‑Checker Hooks
**Status machine**  
Draft → Submit → PendingApproval → (Approve → Active) | (Reject → Rejected)  
Active → Deactivate → Inactive → (Activate → Active)

**Approval constraints**
- Maker ≠ Checker (BR‑103)
- Comment mandatory on Reject
- SLA: 3 business days (auto‑reject on breach; configurable)

**Notifications**
- On submit: notify checkers (Super Admins)
- On decision: notify maker

---

## Interactions & API Contracts
> All APIs must exist in `openapi/leave_mgmt.yaml` with examples and validation.

- **List**: `GET /api/v1/organizations?page&search&status&created_from&created_to` → `{ items[], page, page_size, total_items, total_pages }`
- **Get by ID**: `GET /api/v1/organizations/{id}`
- **Create**: `POST /api/v1/organizations` (requires `Idempotency-Key`)
  - Body: `code, name, login_domains[], vanity_domain?, defaults..., branding?`
  - Result: `201 Created` → returns Draft or PendingApproval per action flag
- **Patch**: `PATCH /api/v1/organizations/{id}` (creates **pending change set**)
- **Approve/Reject**: `POST /api/v1/organizations/{id}:approve` / `:reject`
- **Activate/Deactivate**: `POST /api/v1/organizations/{id}:activate` / `:deactivate`

**Security**
- Auth: Bearer JWT
- RBAC: SuperAdmin only (VAL/AuthZ tests must enforce 403 otherwise)

---

## Validations (map to VAL-*)
- **VAL‑101** Mandatory fields: `code`, `name`, `login_domains[>=1]`, `default_timezone`, `default_country`, `default_currency`
- **VAL‑102** Code format: `^[A-Z0-9_]{2,20}$`; uniqueness platform‑wide; **immutable when Active**
- **VAL‑103** Domains: valid FQDN; `login_domains` unique list; `vanity_domain` optional, unique across platform if present
- **VAL‑104** Working days subset of 7; Leave year start a valid month/day
- **VAL‑105** Logo: types PNG/JPG/SVG; ≤ 1MB; scanned per security‑baseline; stored privately
- **VAL‑106** Maker‑checker: maker ≠ checker; comment required on reject

---

## Business Rules (map to BR-*)
- **BR‑101** No delete; use Inactive. Block deactivate if dependent child entities exist (subsidiaries, locations).
- **BR‑102** Names & codes unique platform‑wide; case‑insensitive compare for name.
- **BR‑103** Maker‑checker enforced for Create/Update/Activate/Deactivate; different user must approve.
- **BR‑104** In SINGLE_TENANT mode: org is seeded; this UI hidden; APIs protected.

---

## UX Copy & States
- Status badges: Draft (secondary), Pending Approval (warning), Active (success), Inactive (secondary), Rejected (danger)
- Toasts: success (4s), error (sticky with “Retry”)
- Error banner on form: “Please correct the highlighted fields.”

---

## Analytics & Audit
- Analytics events: `EVT-ORG-CREATE-SUBMIT`, `EVT-ORG-EDIT-SUBMIT`, `EVT-ORG-APPROVE`, `EVT-ORG-REJECT`
- Audit events (immutable): created, submitted_for_approval, approved, rejected, activated, deactivated; old→new diffs captured in change set

---

## Accessibility
- All controls reachable via keyboard; focus management on modal open/close
- Inputs have labels; error summaries link to fields

---

## Acceptance Criteria (Gherkin)
```gherkin
Feature: Manage Organizations

Scenario: Create organization and submit for approval
  Given I am logged in as SuperAdmin
  And I am on the Organizations page
  When I click "Create Organization"
  And I enter a unique Code and Name
  And I add at least one Login Domain
  And I set Timezone, Country, and Currency
  And I click "Submit for Approval"
  Then I see the organization in "Pending Approval" state
  And checkers receive a notification

Scenario: Prevent same user approving their own change
  Given an organization change set exists in "Pending Approval"
  And the maker is user A
  When user A opens the approval detail
  Then the Approve/Reject controls are disabled
  And a message explains maker ≠ checker

Scenario: Code immutable once Active
  Given an organization is "Active"
  When I edit the organization
  Then the Code field is disabled
  And attempting to patch "code" returns 422

Scenario: Single-tenant mode hides Organizations UI
  Given TENANCY_MODE=SINGLE_TENANT
  When I log in as SuperAdmin
  Then the Organizations menu is not visible
  And direct navigation returns 404 or 403
```
