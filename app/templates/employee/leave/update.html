{% extends "base.html" %}

{% block title %}Update Leave{% endblock %}

{% block head_extras %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<style>
    :root {
        --border-radius: 12px;
        --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        --border-color: #e1e5e9;
        --bg-elevated: #f8f9fa;
        --bg-lighter: #ffffff;
        --text-primary: #2c3e50;
        --text-muted: #6c757d;
        --brand-primary: #6366f1;
        --brand-secondary: #8b5cf6;
        --success: #10b981;
        --success-light: #d1fae5;
        --success-lighter: #ecfdf5;
        --success-border: #a7f3d0;
        --success-dark: #059669;
        --warning: #f59e0b;
        --warning-light: #fef3c7;
        --warning-lighter: #fffbeb;
        --warning-border: #fcd34d;
        --warning-dark: #d97706;
        --info: #3b82f6;
        --info-light: #dbeafe;
        --info-lighter: #eff6ff;
        --info-border: #93c5fd;
        --danger: #ef4444;
    }

    .leave-card {
        transition: all 0.3s ease;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        position: relative;
        overflow: hidden;
        background: white;
        height: 100%;
    }

    .leave-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--brand-primary), var(--brand-secondary));
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .leave-card:hover::before {
        opacity: 1;
    }

    .leave-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .leave-card:hover::after {
        opacity: 1;
    }

    .leave-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .leave-card .card-body {
        padding: 1.25rem;
    }

    .leave-card .card-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.5rem;
    }

    .leave-card .leave-duration {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-bottom: 1rem;
        padding: 0.5rem;
        background: var(--bg-elevated);
        border-radius: var(--border-radius);
        border: 1px solid var(--border-color);
    }

    .leave-card .badge {
        font-size: 0.75rem;
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
    }

    .leave-card .status-badge {
        font-size: 0.75rem;
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .status-badge {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-approved {
        background: var(--success-light);
        color: var(--success);
        border: 1px solid var(--success-border);
    }

    .status-pending {
        background: var(--warning-light);
        color: var(--warning);
        border: 1px solid var(--warning-border);
    }

    .status-saved {
        background: var(--info-light);
        color: var(--info);
        border: 1px solid var(--info-border);
    }

    .icon-primary,
    .icon-secondary,
    .icon-success,
    .icon-info,
    .icon-warning,
    .icon-danger {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.1rem;
    }

    .icon-primary {
        background: var(--brand-primary);
    }

    .icon-secondary {
        background: var(--brand-secondary);
    }

    .icon-success {
        background: var(--success);
    }

    .icon-info {
        background: var(--info);
    }

    .icon-warning {
        background: var(--warning);
    }

    .icon-danger {
        background: var(--danger);
    }

    .filter-tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 2rem;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 1rem;
    }

    .filter-tab {
        padding: 0.5rem 1rem;
        border: none;
        background: none;
        color: var(--text-muted);
        border-radius: var(--border-radius);
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
    }

    .filter-tab.active {
        background: var(--brand-primary);
        color: white;
    }

    .filter-tab:hover:not(.active) {
        background: var(--bg-elevated);
        color: var(--text-primary);
    }

    .leave-duration {
        font-size: 0.875rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
    }

    .update-btn {
        width: 100%;
        margin-top: 0.75rem;
    }

    .leave-card.not-editable {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .leave-card.not-editable .update-btn {
        display: none;
    }

    .leave-card.not-editable::after {
        content: 'Cannot be modified';
        position: absolute;
        top: 10px;
        right: 10px;
        background: var(--text-muted);
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
        z-index: 1;
    }

    .grace-period-warning {
        background: var(--warning-light);
        border: 1px solid var(--warning-border);
        color: var(--warning-dark);
        padding: 1rem;
        border-radius: var(--border-radius);
        margin-bottom: 2rem;
        font-size: 0.875rem;
    }

    .grace-period-warning .time-remaining {
        font-weight: 600;
        color: var(--warning-dark);
    }

    .balance-preview {
        background: linear-gradient(135deg, var(--success-light) 0%, var(--success-lighter) 100%);
        border: 1px solid var(--success-border);
        border-radius: var(--border-radius);
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .balance-preview h4 {
        color: var(--success-dark);
        margin-bottom: 1rem;
        font-size: 1.125rem;
    }

    .balance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 0.75rem;
        max-width: 100%;
    }

    .balance-item {
        text-align: center;
        padding: 1rem;
        background: white;
        border-radius: var(--border-radius);
        border: 1px solid var(--success-border);
    }

    .balance-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--success);
        margin-bottom: 0.25rem;
    }

    .balance-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn.btn-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid var(--border-color);
        background: white;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        text-decoration: none;
        padding: 0;
        line-height: 1;
    }

    .btn.btn-icon i {
        font-size: 1.1rem;
        color: var(--text-primary) !important;
        display: block;
    }

    .btn.btn-icon:hover {
        background: var(--brand-primary);
        color: white;
        border-color: var(--brand-primary);
        transform: scale(1.05);
    }

    .btn.btn-icon:hover i {
        color: white !important;
    }

    /* Ensure icon visibility and positioning */
    .btn.btn-icon .fas,
    .btn.btn-icon .fa {
        font-family: "Font Awesome 5 Free" !important;
        font-weight: 900 !important;
        font-style: normal !important;
        display: inline-block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    /* Override any Bootstrap button text color */
    .btn.btn-icon {
        color: var(--text-primary) !important;
    }

    /* Debug: Make button more visible */
    .btn.btn-icon {
        border: 2px solid var(--border-color) !important;
        background: #f8f9fa !important;
        min-width: 40px !important;
        min-height: 40px !important;
    }

    /* Debug: Make icon more visible */
    .btn.btn-icon i {
        font-size: 1.2rem !important;
        color: var(--text-primary) !important;
        text-shadow: 0 0 2px rgba(0, 0, 0, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<main class="dash-wrap">
    <div class="container-fluid">
        <!-- Header -->
        <div class="dash-header">
            <div class="d-flex align-items-center justify-content-between w-100">
                <div class="header-left">
                    <a href="{{ url_for('employee.dashboard') }}" class="btn btn-icon" data-bs-toggle="tooltip"
                        data-bs-placement="bottom" title="Back to Dashboard">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                </div>
                <div class="header-center text-center">
                    <h1 class="dash-h1">Update Leave</h1>
                    <p class="dash-eyebrow">Modify your leave requests</p>
                </div>
                <div class="header-right">
                    <!-- Empty space for balance -->
                </div>
            </div>
        </div>

        <!-- Grace Period Warning -->
        <div class="grace-period-warning" id="gracePeriodWarning" style="display: none;">
            <i class="fas fa-clock me-2"></i>
            <strong>Today's Leave Modification:</strong> You can modify today's leave until <span
                class="time-remaining">9:00 AM</span>.
            After that, only future leave dates can be modified.
        </div>

        <!-- Leave Balance Preview -->
        <div class="balance-preview" id="balancePreview">
            <h4><i class="fas fa-chart-pie me-2"></i>Your Leave Balance</h4>
            <div class="balance-grid">
                <div class="balance-item">
                    <div class="balance-value" id="sickBalance">15</div>
                    <div class="balance-label">Sick Leave</div>
                </div>
                <div class="balance-item">
                    <div class="balance-value" id="earnedBalance">20</div>
                    <div class="balance-label">Earned Leave</div>
                </div>
                <div class="balance-item">
                    <div class="balance-value" id="casualBalance">10</div>
                    <div class="balance-label">Casual Leave</div>
                </div>
                <div class="balance-item">
                    <div class="balance-value" id="unpaidBalance">30</div>
                    <div class="balance-label">Unpaid Leave</div>
                </div>
                <div class="balance-item">
                    <div class="balance-value" id="maternityBalance">90</div>
                    <div class="balance-label">Maternity Leave</div>
                </div>
                <div class="balance-item">
                    <div class="balance-value" id="paternityBalance">15</div>
                    <div class="balance-label">Paternity Leave</div>
                </div>
                <div class="balance-item">
                    <div class="balance-value" id="compensatoryBalance">5</div>
                    <div class="balance-label">Compensatory Off</div>
                </div>
                <div class="balance-item">
                    <div class="balance-value" id="bereavementBalance">7</div>
                    <div class="balance-label">Bereavement Leave</div>
                </div>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all">All Leaves</button>
            <button class="filter-tab" data-filter="approved">Approved</button>
            <button class="filter-tab" data-filter="pending">Pending</button>
            <button class="filter-tab" data-filter="saved">Saved</button>
        </div>

        <!-- Leave Cards Grid -->
        <div class="row" id="leaveCardsContainer">
            <!-- Leave cards will be populated by JavaScript -->
        </div>
    </div>

    <!-- Update Leave Modal -->
    <div class="modal fade" id="updateLeaveModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header py-3">
                    <h6 class="modal-title mb-0">Update Leave Request</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body py-3">
                    <div class="alert alert-info py-2 mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <small><strong>Note:</strong> Any changes will require re-approval.</small>
                    </div>

                    <form id="updateLeaveForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small mb-1">Leave Type</label>
                                <select class="form-select form-select-sm" id="leaveTypeSelect" required>
                                    <option value="">Select Leave Type</option>
                                    <option value="sick">Sick Leave</option>
                                    <option value="earned">Earned Leave</option>
                                    <option value="casual">Casual Leave</option>
                                    <option value="unpaid">Unpaid Leave</option>
                                    <option value="maternity">Maternity Leave</option>
                                    <option value="paternity">Paternity Leave</option>
                                    <option value="compensatory">Compensatory Off</option>
                                    <option value="bereavement">Bereavement Leave</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small mb-1">Duration (Days)</label>
                                <input type="number" class="form-control form-select-sm" id="leaveDuration" min="1"
                                    max="365" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small mb-1">Start Date</label>
                                <input type="text" class="form-control form-select-sm" id="startDate"
                                    placeholder="Select start date" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small mb-1">End Date</label>
                                <input type="text" class="form-control form-select-sm" id="endDate"
                                    placeholder="Select end date" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label small mb-1">Reason for Leave</label>
                                <textarea class="form-control form-select-sm" id="leaveReason" rows="3"
                                    placeholder="Please provide a reason for the leave modification"
                                    required></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary btn-sm" id="confirmUpdate">Update Leave</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmationModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header py-3">
                    <h6 class="modal-title mb-0">Confirm Leave Update</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body py-3">
                    <p class="mb-3">Are you sure you want to update this leave request?</p>

                    <!-- Compact layout for confirmation details -->
                    <div class="row g-3">
                        <div class="col-md-8">
                            <div class="card bg-light border-0">
                                <div class="card-body p-3">
                                    <h6 class="card-title mb-2">Update Summary</h6>
                                    <div id="updateConfirmationDetails">
                                        <!-- Update details will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="alert alert-warning py-2 mb-0" id="approvalWarning" style="display: none;">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <small><strong>Important:</strong> This will reset the approval status and require
                                    re-approval.</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Go Back</button>
                    <button type="button" class="btn btn-primary btn-sm" id="confirmUpdateLeave">Confirm Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header py-3">
                    <h5 class="modal-title text-success mb-0">
                        <i class="fas fa-check-circle me-2"></i>Leave Updated Successfully
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body py-3">
                    <p class="mb-3">Your leave request has been updated successfully.</p>

                    <!-- Compact layout for leave details and balances -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card bg-success-light border-success h-100">
                                <div class="card-body p-3">
                                    <h6 class="card-title text-success mb-2">Updated Leave Details</h6>
                                    <div id="updatedLeaveDetails">
                                        <!-- Updated leave details will be shown here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-info-light border-info h-100">
                                <div class="card-body p-3">
                                    <h6 class="card-title text-info mb-2">Updated Leave Balances</h6>
                                    <div id="updatedLeaveBalances">
                                        <!-- Balance details will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info small mt-3 mb-0">
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>Next Steps:</strong> Your updated leave request will be sent to your manager for
                        approval.
                    </div>
                </div>
                <div class="modal-footer py-2">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal">Done</button>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block body_extras %}
<script src="{{ url_for('static', filename='js/update-leave.js') }}"></script>
{% endblock %}
